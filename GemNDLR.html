<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDLR Web MIDI Controller v4 (Full CC + Randomizers)</title>
    <style>
        /* ----------------------
        CSS Styling 
        ---------------------- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 1200px;
            margin: auto;
        }

        h1 {
            color: #3498db;
            text-align: center;
        }

        h2 {
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            margin-top: 0;
            color: #1abc9c;
        }

        h3 {
            color: #e67e22;
            margin-top: 5px;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .section-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .section {
            background-color: #34495e;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex: 1 1 280px;
            display: flex;
            flex-direction: column;
        }

        .cc-control-container {
            margin-bottom: 15px;
            border-left: 3px solid #7f8c8d;
            padding-left: 10px;
        }

        .cc-control-container label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ecf0f1;
        }

        select, button {
            padding: 10px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            width: 100%;
            box-sizing: border-box;
            font-size: 14px;
            margin-bottom: 10px;
            color: white;
        }

        select {
            background-color: #2c3e50;
            border: 1px solid #7f8c8d;
        }
        
        #midi-connect-button {
            background-color: #1abc9c;
        }
        #cc-17-button {
            background-color: #e74c3c;
        }

        .randomize-button {
            background-color: #f39c12; /* Orange color for randomization */
            margin-top: 10px;
        }

        .cc-slider {
            display: grid;
            grid-template-columns: 1fr 60px;
            align-items: center;
        }

        .cc-slider input[type=range] {
            width: 100%;
            height: 8px;
            background: #7f8c8d;
            border-radius: 5px;
            outline: none;
        }

        .cc-slider input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
        }

        .cc-slider-value {
            text-align: right;
            font-weight: bold;
            color: #e67e22;
            font-size: 1.1em;
        }

        .toggle-button {
            background-color: #e74c3c;
            transition: background-color 0.1s;
        }
        .toggle-button.active {
            background-color: #2ecc71;
        }
    </style>
</head>
<body>

    <h1>The NDLR Web Controller</h1>

    <div class="section-container">
        <div class="section" style="flex: 1 1 300px;">
            <h2>MIDI Setup & Transport</h2>
            <div class="cc-control-container">
                <label for="midi-out-select">1. Select NDLR MIDI Output:</label>
                <select id="midi-out-select">
                    <option>No MIDI devices found</option>
                </select>
                <button id="midi-connect-button" onclick="initMIDI()">Connect to MIDI</button>
                <p><strong>NDLR Control Channel:</strong> <span id="ndlr-channel">15</span> (Ensure this matches NDLR Settings 1)</p>
            </div>
            
            <div class="cc-control-container">
                <h3>Global Transport</h3>
                <button id="cc-90-button" class="toggle-button" data-cc="90" data-value-on="127" data-value-off="0">
                    Play / Pause All (CC 90)
                </button>
            </div>
             <div class="cc-control-container">
                <h3>Status Dump</h3>
                <button id="cc-17-button" data-cc="17" data-value="99">
                    Request Status Dump (CC 17)
                </button>
            </div>
        </div>

        <div class="section" id="global-controls-section" style="flex: 2 1 500px; display:none;">
            <h2>Global Parameters</h2>
            <div class="section-container" style="gap: 15px; margin-top: 0;">
                <div style="flex: 1 1 200px;">
                    <div class="cc-control-container">
                        <label>Key (CC 73): <span id="cc-73-label">C</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-73-slider" min="1" max="12" value="1" data-cc="73" 
                                data-labels="C,G,D,A,E,B,F#,Db,Ab,Eb,Bb,F">
                            <span class="cc-slider-value" id="cc-73-value">1</span>
                        </div>
                    </div>
                    <div class="cc-control-container">
                        <label>Mode / Scale (CC 74): <span id="cc-74-label">Major</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-74-slider" min="0" max="15" value="0" data-cc="74" 
                                data-labels="Major,Dorian,Phrygian,Lydian,Mixolydian,Minor (Aeolian),Locrian,Gypsy Min,Harmonic Minor,Minor Pentatonic,Whole Tone,Tonic 2nds,Tonic 3rds,Tonic 4ths,Tonic 6ths,Unused">
                            <span class="cc-slider-value" id="cc-74-value">0</span>
                        </div>
                    </div>
                    <div class="cc-control-container">
                        <label>Chord Degree (CC 26): <span id="cc-26-label">I</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-26-slider" min="1" max="7" value="1" data-cc="26" data-labels="I,II,III,IV,V,VI,VII">
                            <span class="cc-slider-value" id="cc-26-value">1</span>
                        </div>
                    </div>
                     <div class="cc-control-container">
                        <label>Chord Type (CC 27): <span id="cc-27-label">Triad</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-27-slider" min="1" max="7" value="1" data-cc="27" 
                                data-labels="Triad,7th,sus2,alt1,alt2,sus4,6th">
                            <span class="cc-slider-value" id="cc-27-value">1</span>
                        </div>
                    </div>
                </div>

                <div style="flex: 1 1 200px;">
                    <div class="cc-control-container">
                        <label>Tempo (CC 72 - BPM): <span id="cc-72-label">130</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-72-slider" min="5" max="127" value="65" data-cc="72">
                            <span class="cc-slider-value" id="cc-72-value">65</span>
                        </div>
                    </div>
                    <div class="cc-control-container">
                        <label>Humanize (CC 59 - %): <span id="cc-59-label">0% (Off)</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-59-slider" min="0" max="10" value="0" data-cc="59"
                                data-labels="Off,10%,20%,30%,40%,50%,60%,70%,80%,90%,100%">
                            <span class="cc-slider-value" id="cc-59-value">0</span>
                        </div>
                    </div>

                    <div class="cc-control-container">
                        <button id="cc-69-toggle" class="toggle-button" data-cc="69" data-value-on="0" data-value-off="127">
                            Chord Inversion (CC 69) - OFF
                        </button>
                    </div>

                    <div class="cc-control-container">
                        <button id="cc-57-toggle" class="toggle-button" data-cc="57" data-value-on="0" data-value-off="127">
                            Black Keys Chord Control (CC 57) - OFF
                        </button>
                    </div>
                    
                    <div class="cc-control-container">
                        <label for="cc-89-select">Load Chord Seq (CC 89):</label>
                        <select id="cc-89-select" data-cc="89" data-labels="Seq #1,Seq #2,Seq #3,Seq #4,Seq #5">
                            </select>
                    </div>
                </div>
            </div>
            
            <h2 style="margin-top: 15px;">Global MIDI Clock & Routing</h2>
            <div class="section-container" style="gap: 15px; margin-top: 0;">
                <div style="flex: 1 1 200px;">
                     <div class="cc-control-container">
                        <label for="cc-68-select">Clock-In Mode (CC 68):</label>
                        <select id="cc-68-select" data-cc="68" data-labels="Internal,5-Pin MIDI A,5-Pin MIDI B,USB 1,USB 2,USB 3,USB 4,Clock In CV">
                            </select>
                    </div>

                    <div class="cc-control-container">
                        <label for="cc-61-select">Clock Out CV PPQ (CC 61):</label>
                        <select id="cc-61-select" data-cc="61" data-labels="1,2,4,24">
                            </select>
                    </div>

                    <div class="cc-control-container">
                        <label for="cc-62-select">Clock Out CV Divide (CC 62):</label>
                        <select id="cc-62-select" data-cc="62" data-labels="1/1,1/2,1/4,1/8,1/16,1/32,1/64">
                            </select>
                    </div>
                </div>
                <div style="flex: 1 1 200px;">
                    <div class="cc-control-container">
                        <label for="cc-58-select">Send MIDI Start/Stop (CC 58):</label>
                        <select id="cc-58-select" data-cc="58" data-labels="All Ports,No Ports,USB 1,USB 2,USB 3,USB 4,USB ALL,5-Pin MIDI A,5-Pin MIDI B,5-Pin A & B">
                            </select>
                    </div>
                    <div class="cc-control-container">
                        <label for="cc-15-select">Set Status MIDI Port (CC 15):</label>
                        <select id="cc-15-select" data-cc="15" data-labels="5-Pin A,5-Pin B,USB 1,USB 2,USB 3,USB 4">
                            </select>
                    </div>

                    <div class="cc-control-container">
                        <label>Set Status MIDI Channel (CC 16): <span id="cc-16-label">1</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-16-slider" min="1" max="16" value="1" data-cc="16">
                            <span class="cc-slider-value" id="cc-16-value">1</span>
                        </div>
                    </div>
                    <div class="cc-control-container">
                        <label>Inbound Transpose Channel (CC 56): <span id="cc-56-label">1</span></label>
                        <div class="cc-slider">
                            <input type="range" id="cc-56-slider" min="1" max="16" value="1" data-cc="56">
                            <span class="cc-slider-value" id="cc-56-value">1</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="section-container" id="part-controls-section" style="display:none;">
        <div class="section">
            <h2>Pad Part</h2>
             <div class="cc-control-container">
                <button id="cc-85-toggle" class="toggle-button" data-cc="85" data-value-on="127" data-value-off="0">
                    Play / Pause (CC 85)
                </button>
                <button class="randomize-button" onclick="randomizePart('Pad')">
                    ✨ Randomize Pad
                </button>
            </div>
            <div class="cc-control-container">
                <label>Position (CC 28): <span id="cc-28-label">50</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-28-slider" min="1" max="100" value="50" data-cc="28">
                    <span class="cc-slider-value" id="cc-28-value">50</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Range (CC 30): <span id="cc-30-label">50</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-30-slider" min="1" max="100" value="50" data-cc="30">
                    <span class="cc-slider-value" id="cc-30-value">50</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Velocity (CC 63): <span id="cc-63-label">64</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-63-slider" min="1" max="127" value="64" data-cc="63">
                    <span class="cc-slider-value" id="cc-63-value">64</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Spread (CC 31): <span id="cc-31-label">1</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-31-slider" min="1" max="6" value="1" data-cc="31">
                    <span class="cc-slider-value" id="cc-31-value">1</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label for="cc-29-select">Strum (CC 29):</label>
                <select id="cc-29-select" data-cc="29" data-labels="None,1/32,1/16,1/8T,3+1/8T,1/8,3+1/8">
                    </select>
            </div>
            <div class="cc-control-container">
                <label>Inter-leaved Poly Chain (CC 67): <span id="cc-67-label">1</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-67-slider" min="1" max="4" value="1" data-cc="67">
                    <span class="cc-slider-value" id="cc-67-value">1</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label for="cc-70-select">Quantization (CC 70):</label>
                <select id="cc-70-select" data-cc="70" data-labels="1/4 note beat,1/8 note beat,none">
                    </select>
            </div>
        </div>

        <div class="section">
            <h2>Drone Part</h2>
            <div class="cc-control-container">
                <button id="cc-86-toggle" class="toggle-button" data-cc="86" data-value-on="127" data-value-off="0">
                    Play / Pause (CC 86)
                </button>
                <button class="randomize-button" onclick="randomizePart('Drone')">
                    ✨ Randomize Drone
                </button>
            </div>
            <div class="cc-control-container">
                <label>Position (CC 32 - Octave): <span id="cc-32-label">4</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-32-slider" min="2" max="6" value="4" data-cc="32">
                    <span class="cc-slider-value" id="cc-32-value">4</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label for="cc-33-select">Type (CC 33):</label>
                <select id="cc-33-select" data-cc="33" 
                    data-labels="Root,Root + Octave,Root + 5th,Root + Octave + 5th">
                    </select>
            </div>
            <div class="cc-control-container">
                <label>Trigger (CC 34): <span id="cc-34-label">1</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-34-slider" min="1" max="19" value="1" data-cc="34">
                    <span class="cc-slider-value" id="cc-34-value">1</span>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>Motif 1 Part</h2>
            <div class="cc-control-container">
                <button id="cc-87-toggle" class="toggle-button" data-cc="87" data-value-on="127" data-value-off="0">
                    Play / Pause (CC 87)
                </button>
                <button class="randomize-button" onclick="randomizePart('Motif 1')">
                    ✨ Randomize Motif 1
                </button>
            </div>
            <div class="cc-control-container">
                <label>Velocity (CC 80): <span id="cc-80-label">64</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-80-slider" min="1" max="127" value="64" data-cc="80">
                    <span class="cc-slider-value" id="cc-80-value">64</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Low Velocity (CC 66): <span id="cc-66-label">50</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-66-slider" min="1" max="100" value="50" data-cc="66">
                    <span class="cc-slider-value" id="cc-66-value">50</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Pattern (CC 38): <span id="cc-38-label">1</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-38-slider" min="1" max="40" value="1" data-cc="38">
                    <span class="cc-slider-value" id="cc-38-value">1</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Pattern Length (CC 36): <span id="cc-36-label">16</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-36-slider" min="1" max="16" value="16" data-cc="36">
                    <span class="cc-slider-value" id="cc-36-value">16</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label for="cc-37-select">Variation (CC 37):</label>
                <select id="cc-37-select" data-cc="37" data-labels="Forward,backward,Ping-Pong,Ping-Pong (w/repeats),Odd-Even,Random">
                    </select>
            </div>
            <div class="cc-control-container">
                <label for="cc-39-select">Clock Divide (CC 39):</label>
                <select id="cc-39-select" data-cc="39" data-labels="1/1,1/2,1/4,1/8,1/3 (Triplets),1/6 (Triplets)">
                    </select>
            </div>
            <div class="cc-control-container">
                <label for="cc-41-select">Accent (CC 41):</label>
                <select id="cc-41-select" data-cc="41" data-labels="Rhythm Vel,Humanized Vel,Motif Vel,Vel Ptrn 1,Vel Ptrn 2,Vel Ptrn 3,Vel Ptrn 4,Vel Ptrn 5,Vel Ptrn 6,Vel Ptrn 7">
                    </select>
            </div>
        </div>

        <div class="section">
            <h2>Motif 2 Part</h2>
             <div class="cc-control-container">
                <button id="cc-88-toggle" class="toggle-button" data-cc="88" data-value-on="127" data-value-off="0">
                    Play / Pause (CC 88)
                </button>
                <button class="randomize-button" onclick="randomizePart('Motif 2')">
                    ✨ Randomize Motif 2
                </button>
            </div>
            <div class="cc-control-container">
                <label>Velocity (CC 65): <span id="cc-65-label">64</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-65-slider" min="1" max="127" value="64" data-cc="65">
                    <span class="cc-slider-value" id="cc-65-value">64</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Position (CC 43): <span id="cc-43-label">1</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-43-slider" min="1" max="10" value="1" data-cc="43">
                    <span class="cc-slider-value" id="cc-43-value">1</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Pattern (CC 46): <span id="cc-46-label">1</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-46-slider" min="1" max="40" value="1" data-cc="46">
                    <span class="cc-slider-value" id="cc-46-value">1</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label>Pattern Length (CC 44): <span id="cc-44-label">16</span></label>
                <div class="cc-slider">
                    <input type="range" id="cc-44-slider" min="1" max="16" value="16" data-cc="44">
                    <span class="cc-slider-value" id="cc-44-value">16</span>
                </div>
            </div>
            <div class="cc-control-container">
                <label for="cc-45-select">Variation (CC 45):</label>
                <select id="cc-45-select" data-cc="45" data-labels="Forward,backward,Ping-Pong,Ping-Pong (w/repeats),Odd-Even,Random">
                    </select>
            </div>
            <div class="cc-control-container">
                <label for="cc-47-select">Clock Divide (CC 47):</label>
                <select id="cc-47-select" data-cc="47" data-labels="1/1,1/2,1/4,1/8,1/3 (Triplets),1/6 (Triplets)">
                    </select>
            </div>
             <div class="cc-control-container">
                <label for="cc-49-select">Accent (CC 49):</label>
                <select id="cc-49-select" data-cc="49" data-labels="Rhythm Vel,Humanized Vel,Motif Vel,Vel Ptrn 1,Vel Ptrn 2,Vel Ptrn 3,Vel Ptrn 4,Vel Ptrn 5,Vel Ptrn 6,Vel Ptrn 7">
                    </select>
            </div>
        </div>
    </div>
    
    <script>
        // 
        // ----------------------
        // JAVASCRIPT LOGIC (Web MIDI API & Randomization)
        // ----------------------
        //

        const NDLR_CONTROL_CHANNEL = 15; 
        let midiAccess = null;
        let midiOutput = null;

        document.getElementById('ndlr-channel').textContent = NDLR_CONTROL_CHANNEL;

        /**
         * Map of CCs for randomization. Only controls with a creative impact are included.
         */
        const RANDOMIZATION_MAP = {
            'Pad': [
                { cc: 28, min: 1, max: 100 }, // Position
                { cc: 30, min: 1, max: 100 }, // Range
                { cc: 29, min: 1, max: 7 },   // Strum
                { cc: 31, min: 1, max: 6 },   // Spread
                { cc: 63, min: 32, max: 127 } // Velocity (safe range)
            ],
            'Drone': [
                { cc: 32, min: 2, max: 6 },   // Position (Octaves)
                { cc: 33, min: 1, max: 4 },   // Type
                { cc: 34, min: 1, max: 19 },  // Trigger
            ],
            'Motif 1': [
                { cc: 35, min: 1, max: 10 },  // Position
                { cc: 36, min: 1, max: 16 },  // Pattern Length
                { cc: 38, min: 1, max: 40 },  // Pattern
                { cc: 37, min: 1, max: 6 },   // Variation
                { cc: 39, min: 1, max: 6 },   // Clock Divide
                { cc: 41, min: 1, max: 10 },  // Accent
                { cc: 80, min: 32, max: 127 } // Velocity (safe range)
            ],
            'Motif 2': [
                { cc: 43, min: 1, max: 10 },  // Position
                { cc: 44, min: 1, max: 16 },  // Pattern Length
                { cc: 46, min: 1, max: 40 },  // Pattern
                { cc: 45, min: 1, max: 6 },   // Variation
                { cc: 47, min: 1, max: 6 },   // Clock Divide
                { cc: 49, min: 1, max: 10 },  // Accent
                { cc: 65, min: 32, max: 127 } // Velocity (safe range)
            ],
        };

        /**
         * Sends a MIDI Control Change (CC) message. 
         */
        function sendCC(channel, ccNumber, ccValue) {
            if (midiOutput) {
                const status = 0xB0 + (channel - 1); 
                midiOutput.send([status, ccNumber, ccValue]);
                console.log(`Sent CC ${ccNumber} value ${ccValue} on Channel ${channel}`);
            }
        }
        
        /**
         * Retrieves the DOM element (slider or select) for a given CC number.
         * @param {number} ccNumber The CC number to find.
         * @returns {HTMLElement} The slider or select element.
         */
        function getControlElement(ccNumber) {
            const id = `cc-${ccNumber}`;
            return document.getElementById(id + '-slider') || document.getElementById(id + '-select');
        }

        /**
         * Updates the visual display for a control element based on its value.
         * @param {number} ccNumber The CC number.
         * @param {number} value The new CC value.
         * @param {HTMLElement} element The DOM element (slider/select).
         */
        function updateDisplay(ccNumber, value, element) {
            const ccValueDisplay = document.getElementById(`cc-${ccNumber}-value`);
            const ccLabelDisplay = document.getElementById(`cc-${ccNumber}-label`);
            const labels = element.dataset.labels ? element.dataset.labels.split(',') : null;

            if (ccValueDisplay) {
                ccValueDisplay.textContent = value;
            }

            if (ccLabelDisplay && labels) {
                // Determine array index based on min value (0 for 0-indexed, 1 for 1-indexed)
                const isZeroIndexed = (element.min === "0" || ccNumber === 74 || element.tagName === 'SELECT' && element.options[0].value === '0');
                const index = isZeroIndexed ? value : value - 1;
                ccLabelDisplay.textContent = labels[index] || value;
            } else if (ccLabelDisplay) {
                ccLabelDisplay.textContent = value;
            }
        }


        window.randomizePart = function(partName) {
            if (!midiOutput) {
                alert('Please connect to a MIDI device first.');
                return;
            }

            const ccList = RANDOMIZATION_MAP[partName];
            if (!ccList) return;

            console.log(`Randomizing ${partName}...`);

            ccList.forEach(item => {
                const ccNumber = item.cc;
                const min = item.min;
                const max = item.max;

                // Generate a random integer value in the range [min, max]
                const randomValue = Math.floor(Math.random() * (max - min + 1)) + min;
                
                const element = getControlElement(ccNumber);

                if (element) {
                    // 1. Update the visual control element
                    element.value = randomValue;
                    
                    // 2. Update the visual labels/values
                    updateDisplay(ccNumber, randomValue, element);
                    
                    // 3. Send the MIDI message
                    sendCC(NDLR_CONTROL_CHANNEL, ccNumber, randomValue);
                }
            });
        };


        /**
         * Helper to initialize dropdowns with options based on data-labels.
         */
        function initializeSelect(selectElement) {
            const labels = selectElement.dataset.labels.split(',');
            selectElement.innerHTML = '';
            
            let startValue = 1; 
            if (parseInt(selectElement.dataset.cc) === 74 || parseInt(selectElement.dataset.cc) === 62) {
                startValue = 0;
            }

            labels.forEach((label, index) => {
                const option = document.createElement('option');
                option.text = label;
                
                // Handle the special case for CC 58 with non-consecutive 0-9 values for 10 labels
                if (parseInt(selectElement.dataset.cc) === 58) {
                    const values = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9];
                    option.value = values[index];
                } else {
                    option.value = startValue + index;
                }
                
                selectElement.add(option);
            });
            
            // Set initial value to the lowest value
            const initialValue = parseInt(selectElement.options[0].value);
            selectElement.value = initialValue;
            sendCC(NDLR_CONTROL_CHANNEL, parseInt(selectElement.dataset.cc), initialValue);
        }

        async function initMIDI() {
            if (!navigator.requestMIDIAccess) {
                alert('Web MIDI API is not supported in this browser (Use Chrome or similar).');
                return;
            }

            try {
                midiAccess = await navigator.requestMIDIAccess({ sysex: false });
                
                const select = document.getElementById('midi-out-select');
                select.innerHTML = '';
                
                const outputs = midiAccess.outputs.values();
                let portsFound = false;

                for (let output of outputs) {
                    const option = document.createElement('option');
                    option.text = output.name;
                    option.value = output.id;
                    select.add(option);
                    portsFound = true;
                }

                if (portsFound) {
                    midiOutput = midiAccess.outputs.get(select.options[0].value);
                    select.options[0].selected = true;
                    document.getElementById('midi-connect-button').textContent = "Connected!";
                    document.getElementById('global-controls-section').style.display = 'flex';
                    document.getElementById('part-controls-section').style.display = 'flex';
                } else {
                    select.innerHTML = '<option>No MIDI devices found</option>';
                    document.getElementById('midi-connect-button').textContent = "Connect to MIDI (No ports found)";
                    document.getElementById('global-controls-section').style.display = 'none';
                    document.getElementById('part-controls-section').style.display = 'none';
                }

                // Event listener to handle port changes
                select.addEventListener('change', (e) => {
                    midiOutput = midiAccess.outputs.get(e.target.value);
                });


                // 1. Attach listeners to all CC Sliders
                document.querySelectorAll('input[type=range][data-cc]').forEach(slider => {
                    const ccNumber = parseInt(slider.dataset.cc);
                    
                    // Initial update & set value
                    const initialValue = parseInt(slider.value);
                    updateDisplay(ccNumber, initialValue, slider);
                    sendCC(NDLR_CONTROL_CHANNEL, ccNumber, initialValue);


                    slider.addEventListener('input', (e) => {
                        const value = parseInt(e.target.value);
                        updateDisplay(ccNumber, value, slider);
                        sendCC(NDLR_CONTROL_CHANNEL, ccNumber, value);
                    });
                });

                // 2. Attach listeners to all CC Select Dropdowns
                 document.querySelectorAll('select[data-cc]').forEach(selectElement => {
                    // Initialize options
                    initializeSelect(selectElement);
                    
                    selectElement.addEventListener('change', (e) => {
                        const ccNumber = parseInt(e.target.dataset.cc);
                        const value = parseInt(e.target.value);
                        updateDisplay(ccNumber, value, selectElement); // Update display for select too
                        sendCC(NDLR_CONTROL_CHANNEL, ccNumber, value);
                    });
                });


                // 3. Attach listeners to all Toggle Buttons (Play/Pause, On/Off)
                document.querySelectorAll('button.toggle-button').forEach(toggleButton => {
                    const ccNumber = parseInt(toggleButton.dataset.cc);
                    const valueOn = parseInt(toggleButton.dataset.valueOn);
                    const valueOff = parseInt(toggleButton.dataset.valueOff);
                    let isToggledOn = false; 

                    // Set initial state (assuming Off/Paused)
                    if (ccNumber === 90) {
                        toggleButton.textContent = "▶️ Play All (CC 90)"; 
                    } else if (ccNumber === 69) {
                        toggleButton.textContent = "Chord Inversion (CC 69) - OFF"; 
                    } else if (ccNumber === 57) {
                        toggleButton.textContent = "Black Keys Chord Control (CC 57) - OFF";
                    } else {
                        toggleButton.textContent = "▶️ Play / Pause (CC " + ccNumber + ")"; 
                    }
                    
                    // Send initial CC Off/Pause value
                    sendCC(NDLR_CONTROL_CHANNEL, ccNumber, valueOff);


                    toggleButton.addEventListener('click', () => {
                        isToggledOn = !isToggledOn;
                        const valueToSend = isToggledOn ? valueOn : valueOff;
                        
                        if (isToggledOn) {
                            toggleButton.classList.add('active');
                            if (ccNumber === 90) {
                                toggleButton.textContent = "⏸️ Pause All (CC 90)";
                            } else if (ccNumber === 69) {
                                toggleButton.textContent = "Chord Inversion (CC 69) - ON"; 
                            } else if (ccNumber === 57) {
                                toggleButton.textContent = "Black Keys Chord Control (CC 57) - ON";
                            } else {
                                toggleButton.textContent = "⏸️ Pause (CC " + ccNumber + ")"; 
                            }
                        } else {
                            toggleButton.classList.remove('active');
                            if (ccNumber === 90) {
                                toggleButton.textContent = "▶️ Play All (CC 90)";
                            } else if (ccNumber === 69) {
                                toggleButton.textContent = "Chord Inversion (CC 69) - OFF"; 
                            } else if (ccNumber === 57) {
                                toggleButton.textContent = "Black Keys Chord Control (CC 57) - OFF";
                            } else {
                                toggleButton.textContent = "▶️ Play / Pause (CC " + ccNumber + ")"; 
                            }
                        }
                        sendCC(NDLR_CONTROL_CHANNEL, ccNumber, valueToSend);
                    });
                });

                // 4. Attach listener for one-shot button (Get Status CC 17)
                const statusButton = document.getElementById('cc-17-button');
                statusButton.addEventListener('click', () => {
                    const ccNumber = parseInt(statusButton.dataset.cc);
                    const value = parseInt(statusButton.dataset.value);
                    sendCC(NDLR_CONTROL_CHANNEL, ccNumber, value);
                });


            } catch (e) {
                alert('Failed to get MIDI access. Ensure your MIDI device is plugged in and recognized.');
                console.error('MIDI Access Error:', e);
            }
        }
    </script>

</body>
</html>